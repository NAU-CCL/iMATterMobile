{"ast":null,"code":"var _a;\n\nimport { __decorate, __metadata } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { AngularFirestore } from '@angular/fire/firestore';\nimport { FormBuilder } from '@angular/forms';\nimport { Validators } from '@angular/forms';\nimport { GetReviewSurveyService } from '../../../../services/get-review-survey.service';\nimport { ActivatedRoute, Router } from \"@angular/router\";\nimport { LocationService } from \"src/app/services/resource.service\";\nimport { ResourceTypesService } from 'src/app/services/resource-types.service';\nimport { Storage } from '@ionic/storage';\nimport { DatePipe } from '@angular/common';\nlet CreateReviewPage = class CreateReviewPage {\n  constructor(route, afs, fb, reviewSurveyService, resourceService, resourceTypesService, storage, router, datepipe) {\n    this.route = route;\n    this.afs = afs;\n    this.fb = fb;\n    this.reviewSurveyService = reviewSurveyService;\n    this.resourceService = resourceService;\n    this.resourceTypesService = resourceTypesService;\n    this.storage = storage;\n    this.router = router;\n    this.datepipe = datepipe;\n    this.questionsLoaded = false;\n    this.resourceName = \"\"; // Each index repesents 1 of 5 stars on the reivew page. False means the star is not filled.\n\n    this.rating_array = [false, false, false, false, false]; // The users 1-5 star rating of the rescource, contains an int between 1-5.\n\n    this.selected_rating = 1;\n    this.hasTouchedStars = false; // Any explicitly defined FormControls can be retreived using a get method like the one below. get is an AbstractControl method.\n\n    this.newReviewForm = this.fb.group({\n      reviewSubject: ['', Validators.required],\n      reviewText: ['', Validators.required],\n      reviewSurveyAnswers: this.fb.array([])\n    }); // Get the reviews collection so we can add new reviews to it.\n\n    this.reviewsCollection = this.afs.collection('resourceReviews');\n    this.storage.get('userCode').then(userID => {\n      this.userID = userID;\n    });\n  }\n\n  ngOnInit() {\n    // Get the resource ID from the url see resources-routing.module to see where the id param is specified.\n    this.route.params.subscribe(params => {\n      this.resourceID = params['id'];\n      this.resourceService.getLocation(this.resourceID.toString()).subscribe(resource => {\n        this.resourceObj = resource;\n        this.resourceName = this.resourceObj.title; // Get the survey and its questions and load them into the form\n\n        this.loadSurveyReviewQuestionsIntoForm();\n        console.log(` THIS RESOURCE: ${JSON.stringify(this.resourceObj)}`);\n      });\n    });\n  }\n\n  get reviewSurveyAnswers() {\n    return this.newReviewForm.get('reviewSurveyAnswers');\n  } // Get a formcontrol element from our FormGroup newReviewForm so we can display the value as the user types for testing.\n\n\n  get reviewText() {\n    return this.newReviewForm.get('reviewText');\n  }\n\n  get reviewSubject() {\n    return this.newReviewForm.get('reviewSubject');\n  } // Get a formcontrol element from our FormGroup newReviewForm so we can display the value as the user types for testing or get the value the user entered for that form element!.\n\n\n  get reviewRating() {\n    return this.newReviewForm.get('reviewRating');\n  } //ReviewQuestions { review_questions_id: number, is_current: boolean, review_questions: string[], review_question_types: string[], question_tags: string[] }\n\n\n  loadSurveyReviewQuestionsIntoForm() {\n    this.reviewQuestionsQuery = this.reviewSurveyService.getReviewQuestionsForResources();\n    this.reviewQuestionsQuery.get().then(querySnap => {\n      querySnap.forEach(docSnap => {\n        this.reviewQuestionsJSON = docSnap.data();\n        this.surveyQuestionsArray = this.reviewQuestionsJSON['review_questions'];\n        this.surveyQuestionTypes = this.reviewQuestionsJSON['review_question_types'];\n        this.surveyTagsArray = this.reviewQuestionsJSON['question_tags']; //console.log(`SURVEYS ${ JSON.stringify( this.reviewQuestionsJSON ) } `);\n\n        this.currentResourceTypes = this.resourceObj['type']; //console.log(`Current Resource Types ${this.currentResourceTypes}`);\n        // Filter the questions array, types array, and tags array to only questions that apply to this resource are shown!\n        // For example, Some questions are only for couseling resources or something similar.\n        // Get the types associated with the current resource.\n\n        this.filterSurveyQuestionArrays(this.surveyQuestionsArray, this.surveyQuestionTypes, this.surveyTagsArray); // Add an alias aka anonymous form control to the form array. Each alias represents an input for each question asked of the user.\n\n        this.generateSurveyQuestionInputs(this.surveyQuestionsArray);\n        this.questionsLoaded = true;\n      });\n    });\n  }\n\n  addAlias() {\n    this.reviewSurveyAnswers.push(this.fb.control(''));\n  }\n\n  deleteReview(reviewID) {} // Deletes all reviews from the review collection.\n\n\n  deleteAllReviews() {\n    this.afs.firestore.collection(\"resourceReviews\").get().then(querySnapshot => {\n      querySnapshot.forEach(aReview => {\n        aReview.ref.delete();\n      });\n    });\n  } // Return false to prevent form submission.\n\n\n  submitNewReview() {\n    console.log(` THIS FORM IS ${JSON.stringify(this.newReviewForm.value)}`);\n    let currentDate = new Date();\n\n    for (let index = 0; index < this.reviewSurveyAnswers.value.length; index++) {\n      console.log(`Survety answers value array ${JSON.stringify(this.reviewSurveyAnswers.value)} INDEX ${JSON.stringify(this.reviewSurveyAnswers.value[index])}`); // If the question was not answered, default to na for the answer to this question.\n\n      if (this.reviewSurveyAnswers.value[index] === undefined) {\n        this.reviewSurveyAnswers.value[index] = 'na';\n        console.log(`Converting null to na`);\n      }\n    }\n\n    console.log(` THIS FORM IS AFTER ${JSON.stringify(this.newReviewForm.value)}`);\n    let reviewObj = {\n      resourceID: this.resourceID,\n      reviewDate: currentDate,\n      userID: this.userID,\n      reviewSubject: this.reviewSubject.value,\n      reviewText: this.reviewText.value,\n      reviewRating: this.selected_rating,\n      survey_questions: this.surveyQuestionsArray,\n      survey_answers: this.reviewSurveyAnswers.value,\n      survey_tags: this.surveyTagsArray\n    };\n    this.reviewsCollection.add(reviewObj);\n    this.router.navigate([`/tabs/more/resources/${this.resourceID}/`]);\n  }\n\n  getAllResourceTypes(surveyQuestionsArray, surveyQuestionTypes, surveyTagsArray) {\n    // This query retrieves an array of all available resource types in our db.\n    let resourceTypesQuery = this.resourceTypesService.getResourceTypes();\n    resourceTypesQuery.get().then(querySnap => {\n      querySnap.forEach(docSnap => {\n        // Get all resource types available to be used by resources. Probably can be removed.\n        this.allResourceTypes = docSnap.data()['types'];\n        console.log(`ALL RESOURCE TYPES ARRAY: ${this.allResourceTypes}`);\n      });\n    });\n  } // A resources types field can be: an array, where each index is a single type, or a string that is a references a single type.\n\n\n  filterSurveyQuestionArrays(surveyQuestionsArray, surveyQuestionTypes, surveyTagsArray) {\n    let removeArrayIndexes = []; // Iterate through each type string for each question. For example, currentQuestionTypeArray will likely look like this ['Housing','Food', 'MAT Provider']\n\n    for (let index = 0; index < surveyQuestionTypes.length; index++) {\n      let currentQuestionTypeArray = surveyQuestionTypes[index].split(',');\n      let removeQuestion = true; // keeps track of whether we should remove the question. Remove the question until proven otherwise.\n\n      console.log(`Current Question Type array ${currentQuestionTypeArray}`); // Iterate through the current question types so we can compare them to the resource types.\n\n      for (let currQuesTypeIndex = 0; currQuesTypeIndex < currentQuestionTypeArray.length; currQuesTypeIndex++) {\n        let currentType = currentQuestionTypeArray[currQuesTypeIndex];\n        console.log(`All types for current question = ${JSON.stringify(currentQuestionTypeArray)}. Current Question Type ${currentType}. `);\n\n        if (this.currentResourceTypes.includes(currentType) || currentType === \"All\") // Detirmine if the current question type is inlcluded in the array of types for this resource.\n          {\n            removeQuestion = false;\n          }\n      } // If the question type was not included in the current resource types array, remove it.\n\n\n      if (removeQuestion) {\n        removeArrayIndexes.push(index);\n      }\n    } // Remove the elements starting with the greatest index. This is to avoid shrinking the array and making our indexes out of bounds.\n\n\n    for (let deleteIndex = removeArrayIndexes.length - 1; deleteIndex > -1; deleteIndex--) {\n      console.log(`Element indexes to remove ${JSON.stringify(removeArrayIndexes)}`);\n      console.log(`Removing question ${surveyQuestionsArray[removeArrayIndexes[deleteIndex]]} with types ${surveyQuestionTypes[removeArrayIndexes[deleteIndex]]} and tags ${surveyTagsArray[removeArrayIndexes[deleteIndex]]}`); // Remove the element at index in these three arrays since they all correspond to each other.\n\n      surveyQuestionsArray.splice(removeArrayIndexes[deleteIndex], 1);\n      surveyQuestionTypes.splice(removeArrayIndexes[deleteIndex], 1);\n      surveyTagsArray.splice(removeArrayIndexes[deleteIndex], 1);\n      console.log(`Questions Array after removing: ${JSON.stringify(surveyQuestionsArray)} with types ${JSON.stringify(surveyQuestionTypes)} and tags ${JSON.stringify(surveyTagsArray)}`);\n    }\n  } // Iterates through each survey question retrived from the database and creates a new Form Control for each which are used in our form builder. See angular reactive forms for more information.\n  // Specifically we are using a formbuilder plus a form array. Form arrays allow for elements to be added to a form dynamically.\n\n\n  generateSurveyQuestionInputs(questions) {\n    for (let index = 0; index < questions.length; index++) {\n      this.addAlias();\n    }\n  }\n\n  updateRatingStars(starIndex) {\n    this.rating_array = [false, false, false, false, false];\n\n    for (let index = 0; index < this.rating_array.length; index++) {\n      if (index <= starIndex) {\n        this.rating_array[index] = true;\n      }\n    }\n\n    this.selected_rating = starIndex + 1;\n  }\n\n};\nCreateReviewPage = __decorate([Component({\n  selector: 'app-create-review',\n  templateUrl: './create-review.page.html',\n  styleUrls: ['./create-review.page.scss']\n}), __metadata(\"design:paramtypes\", [ActivatedRoute, typeof (_a = typeof AngularFirestore !== \"undefined\" && AngularFirestore) === \"function\" ? _a : Object, FormBuilder, GetReviewSurveyService, LocationService, ResourceTypesService, Storage, Router, DatePipe])], CreateReviewPage);\nexport { CreateReviewPage };","map":null,"metadata":{},"sourceType":"module"}